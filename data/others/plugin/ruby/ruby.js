!function(){var t=TYRANO.kag.stat.mp;TYRANO.kag.stat.show=t.show||"each",TYRANO.kag.stat.ruby_type=t.type||"center";var a=TYRANO.kag.stat.ruby_dic;if(void 0===a){a={};$.getJSON("./data/others/plugin/ruby/dic.json",function(t){for(var s in t)a[s]={ruby:t[s],count:0};TYRANO.kag.stat.ruby_dic=a})}var s=function(t,a){var s=e(t,TYRANO.kag.stat.font.size),n=e(a,TYRANO.kag.config.defaultRubySize),i=-1*TYRANO.kag.stat.font.size+-1*TYRANO.kag.config.defaultRubyOffset;return{text:a,ruby_size:TYRANO.kag.config.defaultRubySize,ruby_offset:i,font_size:TYRANO.kag.stat.font.size,str_width:s,text_width:n,startpos:(s-n)/2}},e=function(t,a){var s=TYRANO.kag.stat.font.face;$("body").append("<span id='font_width' style='visibility:hidden;position:absolute;white-space:nowrap;font-size:"+a+"px;font-family:"+s+";'></span>");var e=$("#font_width").text(t).get(0).offsetWidth;return $("#font_width").remove(),e},n={center:function(t,a,s,e){var n="<span class='ruby_str"+t+"' style='display:inline-block;position:relative; width:"+a.str_width+"px; font-size:"+a.font_size+"px;'>"+s;return n+="<span class='ruby_text"+t+"' style='position:absolute; width:"+a.text_width+"px; white-space: nowrap; font-size:"+a.ruby_size+"px; top:"+a.ruby_offset+"px; left:"+a.startpos+"px;'>"+e,n+="</span></span>"},justify:function(t,a,s,e){if(1===a.text.length||a.text_width-a.str_width>0)return this.center.apply(this,arguments);var n=(a.str_width-a.text_width)/(a.text.length-1),i="<span class='ruby_str"+t+"' style='display:inline-block;position:relative; width:"+a.str_width+"px; font-size:"+a.font_size+"px;'>"+s;return i+="<span class='ruby_text"+t+"' style='position:absolute;letter-spacing:"+n+"px;width:100%; white-space: nowrap; font-size:"+a.ruby_size+"px; top:"+a.ruby_offset+"px; left:0;'>"+e,i+="</span></span>"}};TYRANO.kag.stat.ruby_no=-1;var i=function(t,a,e){TYRANO.kag.stat.ruby_text=[];var i=s(t,a);TYRANO.kag.stat.ruby_no++;for(var r=TYRANO.kag.stat.ruby_no,g=Math.ceil(parseInt(a.length)/parseInt(t.length)),o=0;o<a.length;o++){var f=a.substr(o,g);TYRANO.kag.stat.ruby_text.push(f),o=o+g-1}return n[TYRANO.kag.stat.ruby_type](r,i,e,TYRANO.kag.stat.ruby_text[0])};TYRANO.kag.stat.ruby_manual=[],tyrano.plugin.kag.tag.ruby.start=function(t){TYRANO.kag.stat.ruby_text=[];var a=t.str||"",s=t.text;TYRANO.kag.stat.ruby_no++;TYRANO.kag.stat.ruby_no;for(var e=Math.ceil(parseInt(s.length)/parseInt(a.length)),n=0;n<s.length;n++){var i=s.substr(n,e);TYRANO.kag.stat.ruby_text.push(i),n=n+e-1}this.kag.stat.ruby_manual=[a,s],""!=a?this.kag.ftag.startTag("text",{val:a}):this.kag.ftag.nextOrder()},tyrano.plugin.kag.tag.text.showMessage=function(t,a){var e=this,r=TYRANO.kag.stat.ruby_dic,g=[];for(var o in r)for(var f,u=new RegExp(o+"(.*?)","g");f=u.exec(t);)g.push([f.index,o,r[o].ruby]);g=g.sort(function(t,a){return t[0]-a[0]}),"true"==e.kag.stat.log_join&&(a.backlog="join");var p=$.isNull($(".chara_name_area").html());if(""!=p&&"join"!=a.backlog||""!=p&&"true"==this.kag.stat.f_chara_ptext)this.kag.pushBackLog("<b class='backlog_chara_name "+p+"'>"+p+"</b>ï¼š<span class='backlog_text "+p+"'>"+t+"</span>","add"),"true"==this.kag.stat.f_chara_ptext&&(this.kag.stat.f_chara_ptext="false",this.kag.stat.log_join="true");else{var k="<span class='backlog_text "+p+"'>"+t+"</span>";"join"==a.backlog?this.kag.pushBackLog(k,"join"):this.kag.pushBackLog(k,"add")}e.kag.ftag.hideNextImg(),function(a){""==a.html()&&a.append("<p class=''></p>");var r=t,o="";0!=a.find("p").find(".current_span").length&&(o=a.find("p").find(".current_span").html());var f=0;e.kag.checkMessage(a);var u=e.kag.getMessageCurrentSpan();if(u.css({color:e.kag.stat.font.color,"font-weight":e.kag.stat.font.bold,"font-size":e.kag.stat.font.size+"px","font-family":e.kag.stat.font.face,"font-style":e.kag.stat.font.italic}),""!=e.kag.stat.font.edge){var p=e.kag.stat.font.edge;u.css("text-shadow","1px 1px 0 "+p+", -1px 1px 0 "+p+",1px -1px 0 "+p+",-1px -1px 0 "+p)}else""!=e.kag.stat.font.shadow&&u.css("text-shadow","2px 2px 2px "+e.kag.stat.font.shadow);"true"==e.kag.config.autoRecordLabel&&(1==e.kag.stat.already_read?"default"!=e.kag.config.alreadyReadTextColor&&u.css("color",$.convertColor(e.kag.config.alreadyReadTextColor)):"false"==e.kag.config.unReadTextSkip&&(e.kag.stat.is_skip=!1));var k=30;""!=e.kag.stat.ch_speed?k=parseInt(e.kag.stat.ch_speed):e.kag.config.chSpeed&&(k=parseInt(e.kag.config.chSpeed));var l=0,c=0,_=function(t){var u,p,_,h,d=r.substring(f,++f);if(0!=e.kag.stat.ruby_manual.length){var b=e.kag.stat.ruby_manual[0],y=e.kag.stat.ruby_manual[1];if(""!=b)if(b.substr(0,1)==d)l=b.length-1,o+=i(b,y,d),1==b.length&&(e.kag.stat.ruby_manual=[]);else{c++;var x=".ruby_text"+TYRANO.kag.stat.ruby_no;a.find("p").find(".current_span").find(x).before(d),a.find("p").find(".current_span").find(x).append(TYRANO.kag.stat.ruby_text[c]),o=a.find("p").find(".current_span").html(),b.length-1==c&&(e.kag.stat.ruby_manual=[])}else u=d,p=y,_=TYRANO.kag.stat.ruby_no,h=s(u,p),d=n[TYRANO.kag.stat.ruby_type](_,h,u,p),o+=d,e.kag.stat.ruby_manual=[]}else if(0!=g.length){var R=g[0][0];b=g[0][1],y=g[0][2];if(R==f-1){switch(TYRANO.kag.stat.show){case"each":l=b.length-1,o+=i(b,y,d),1==b.length&&g.shift();break;case"once":0==TYRANO.kag.stat.ruby_dic[b].count?(l=b.length-1,o+=i(b,y,d)):o+=d,1==b.length&&g.shift();break;default:l=b.length-1,o+=i(b,y,d),1==b.length&&g.shift()}TYRANO.kag.stat.ruby_dic[b].count=TYRANO.kag.stat.ruby_dic[b].count+1}else if(l>c){c++;x=".ruby_text"+TYRANO.kag.stat.ruby_no;a.find("p").find(".current_span").find(x).before(d),a.find("p").find(".current_span").find(x).append(TYRANO.kag.stat.ruby_text[c]),o=a.find("p").find(".current_span").html(),l==c&&(g.shift(),l=0,c=0)}else o+=d}else o+=d;e.kag.appendMessage(a,o),f<=r.length?(e.kag.stat.is_adding_text=!0,1==e.kag.stat.is_click_text||1==e.kag.stat.is_skip||1==e.kag.stat.is_nowait?t(t):setTimeout(function(){t(t)},k)):(e.kag.stat.is_adding_text=!1,e.kag.stat.is_click_text=!1,"true"!=e.kag.stat.is_stop&&(1==e.kag.stat.is_skip||1==e.kag.stat.is_nowait||k<3?(e.kag.appendMessage(a,o),setTimeout(function(){e.kag.stat.is_hide_message||e.kag.ftag.nextOrder()},parseInt(e.kag.config.skipSpeed))):e.kag.stat.is_hide_message||e.kag.ftag.nextOrder()))};_(_)}(this.kag.getMessageInnerLayer())}}();